<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROS2 Web Interface</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-right: 20px;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }
        .ui-element {
            margin-bottom: 10px;
        }
        .command-input {
            margin-bottom: 10px;
        }
        .chat-message {
            margin-bottom: 10px;
        }
        .status-indicator {
            padding: 2px 5px;
        }
        .output-content {
            margin-top: 5px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 4px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .output-content {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 10px;
            border-left: 3px solid #007bff;
            margin-top: 5px;
        }
        .command-highlight {
            font-weight: bold;
            color: #0000FF;
            margin-right: 1em;
        }
        .command-controls {
            margin-top: 5px;
        }
        .command-controls label {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>ROS2 Web Interface</h1>
        <div id="chat" class="chat-container"></div>
        <form class="pure-form" onsubmit="sendCommand(); return false;">
            <input type="text" id="command-input" class="pure-input-1 command-input" placeholder="Command">
            <button type="submit" class="pure-button pure-button-primary">Send Command</button>
            <button type="button" class="pure-button" onclick="addButton()">Add Button</button>
        </form>
    </div>
    <div class="sidebar">
        <div class="sidebar-content">
            <h2>Custom Buttons</h2>
            <div id="ui-elements"></div>
        </div>
        <button type="button" class="pure-button clear-all-button" onclick="clearAllInputs()">Clear All Inputs</button>
    </div>

    <script>
        const activeCommands = new Set();
        const commandLogs = {};
        const commandLogsFullyVisible = {};

        function sendCommand(command) {
            command = command || document.getElementById('command-input').value;
            fetch('/send_command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: command }),
            })
            .then(response => response.json())
            .then(data => {
                appendToChatLog(`Command sent: <span class="command-highlight">${command}</span>`, data.id);
                activeCommands.add(data.id);
                commandLogs[data.id] = [];
                commandLogsFullyVisible[data.id] = false;
                pollCommandStatus(data.id);
                document.getElementById('command-input').value = '';
            })
            .catch(error => appendToChatLog(`Error sending command: ${error}`));
        }

        function pollCommandStatus(commandId) {
            const intervalId = setInterval(() => {
                if (!activeCommands.has(commandId)) {
                    clearInterval(intervalId);
                    return;
                }
                fetch('/get_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: commandId }),
                })
                .then(response => response.json())
                .then(data => {
                    updateCommandMessage(commandId, data.status, data.output);
                    if (data.status !== "queued" && data.status !== "running") {
                        activeCommands.delete(commandId);
                    }
                })
                .catch(error => {
                    appendToChatLog(`Error getting status: ${error}`);
                    activeCommands.delete(commandId);
                });
            }, 100);
        }

        function updateCommandMessage(commandId, status, output) {
            const logEntry = document.getElementById(`log-${commandId}`);
            if (logEntry) {
                logEntry.querySelector('.status-indicator').textContent = getStatusEmoji(status);
                if (output) {
                    commandLogs[commandId] = output.split('\n');
                    const logContent = logEntry.querySelector('.output-content') || createLogContent(commandId);
                    updateLogContent(logContent, commandId);
                }

                // Update stop button visibility
                const stopButton = logEntry.querySelector('#stop-button-' + commandId);
                if (stopButton) {
                    stopButton.style.display = (status === "running" || status === "queued") ? "inline-block" : "none";
                }
            }
        }

        function createLogContent(commandId) {
            const logEntry = document.getElementById(`log-${commandId}`);
            const logButton = document.createElement('button');
            logButton.textContent = 'Show Full Log';
            logButton.className = 'pure-button log-button';
            logButton.onclick = () => toggleLog(commandId);
            logEntry.appendChild(logButton);
            const stopButton = document.createElement('button');
            stopButton.textContent = 'Stop';
            stopButton.id = `stop-button-${commandId}`;
            stopButton.className = 'pure-button stop-button';
            stopButton.onclick = () => stopCommand(commandId);
            logEntry.appendChild(stopButton);
            const logContent = document.createElement('div');
            logContent.id = `log-content-${commandId}`;
            logContent.className = 'output-content';
            logEntry.appendChild(logContent);
            const logButtonEnd = document.createElement('button');
            logButtonEnd.textContent = 'Collapse Log';
            logButtonEnd.className = 'pure-button log-button';
            logButtonEnd.style.display = "none";
            logButtonEnd.onclick = () => toggleLog(commandId);
            logEntry.appendChild(logButtonEnd);
            return logContent;
        }

        function updateLogContent(logContent, commandId) {
            let lines = commandLogs[commandId];
            while (lines[lines.length-1] && lines[lines.length-1].trim() === '') {
                lines = lines.slice(0, -1);
            }
            const visibleLines = commandLogsFullyVisible[commandId] ? lines.join('\n') : (lines.length > 3 ? '...\n' : '') + lines.slice(-3).join('\n');
            logContent.innerHTML = `<div class="visible-lines">${visibleLines}</div>`;
            const logButton = logContent.previousElementSibling.previousElementSibling;
            logButton.style.display = lines.length > 3 ? "inline-block" : "none";
        }

        function toggleLog(commandId) {
            let lines = commandLogs[commandId];
            while (lines[lines.length-1].trim() === '') {
                lines = lines.slice(0, -1);
            }
            const logContent = document.getElementById(`log-content-${commandId}`);
            const visibleLines = logContent.querySelector('.visible-lines');
            const logButton = logContent.previousElementSibling.previousElementSibling;
            const logButtonEnd = logContent.nextElementSibling;
            commandLogsFullyVisible[commandId] ^= 1;

            if (commandLogsFullyVisible[commandId]) {
                visibleLines.innerHTML = lines.join('\n');
                logButton.textContent = "Show Last 3 Lines";
                logButtonEnd.style.display = "inline-block";
            } else {
                visibleLines.innerHTML = (lines.length > 3 ? '...\n' : '') + lines.slice(-3).join('\n');
                logButton.textContent = "Show Full Log";
                logButtonEnd.style.display = "none";
            }
        }

        function stopCommand(commandId) {
            fetch('/stop_command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: commandId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== "stopping") {
                    appendToChatLog(`Failed to stop command: ${commandId}`);
                }
            })
            .catch(error => appendToChatLog(`Error stopping command: ${error}`));
        }

        function addButton() {
            const cmd_input = document.getElementById('command-input').value;
            const command = cmd_input.replace(/'/g, "\\'");
            const name = cmd_input;
            const element = document.createElement('div');
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'command-controls';
            element.appendChild(controlsDiv);
            const commandFunction = addCommandControls(controlsDiv, command);
            element.className = 'ui-element';
            const mainButton = document.createElement('button');
            mainButton.className = 'pure-button pure-button-primary';
            mainButton.textContent = name;
            mainButton.onclick = () => sendCommand(commandFunction());
            element.appendChild(mainButton);
            const editButton = document.createElement('button');
            editButton.className = 'pure-button';
            editButton.textContent = 'Edit';
            editButton.onclick = () => editElement(editButton);
            element.appendChild(editButton);
            const deleteButton = document.createElement('button');
            deleteButton.className = 'pure-button';
            deleteButton.textContent = 'Delete';
            deleteButton.onclick = () => deleteElement(deleteButton);
            element.appendChild(deleteButton);
            document.getElementById('ui-elements').appendChild(element);
            saveButtons();
        }

        function addCommandControls(container, command) {
            const regex = /{{{([^}]+)}}}/g;
            const args = [];
            let match;
            while ((match = regex.exec(command)) !== null) {
                const [input_type, params] = match[1].split('(');
                const input_id = `input-${Math.random().toString(36).substr(2, 9)}`;
                if (input_type === 'checkbox') {
                    const value = params.slice(0, -1);
                    const label = document.createElement('label');
                    label.innerText = `${input_type}(${value})`;
                    container.appendChild(label);
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = input_id;
                    label.appendChild(checkbox);
                    // label.innerText += match[1];
                    args.push(checkbox);
                } else if (input_type === 'slider') {
                    const [start, end] = params.slice(0, -1).split(',').map(Number);
                    const label = document.createElement('label');
                    label.innerText = `${input_type}(${start},${end})`;
                    container.appendChild(label);
                    const range = document.createElement('input');//, type='range', id=input_id, min=start, max=end, value=start);
                    range.type = 'range';
                    range.id = input_id;
                    range.min = start;
                    range.max = end;
                    label.appendChild(range);
                    // label.innerText += match[1];
                    args.push(range);
                }
            }
            const f = () => {
                const a = args.slice();
                return command.replace(regex, (match, p1) => {
                    const [type, params] = p1.split('(');
                    if (type === 'checkbox') {
                        const value = params.slice(0, -1);
                        return a.shift().checked ? value : '';
                    } else if (type === 'slider') {
                        const [start, end] = params.slice(0, -1).split(',').map(Number);
                        return a.shift().value;
                    }
                    return match;
                });
            };
            return f;
        }

        function editElement(button) {
            const element = button.closest('.ui-element');
            const commandButton = element.querySelector('.pure-button-primary');
            const newCommand = prompt("Enter new command:", commandButton.textContent);
            if (newCommand) {
                commandButton.textContent = newCommand;
                const controlsDiv = element.querySelector('.command-controls');
                controlsDiv.innerHTML = '';
                commandFunction = addCommandControls(controlsDiv, newCommand);
                commandButton.onclick = () => sendCommand(commandFunction());
                saveButtons();
            }
        }

        function deleteElement(button) {
            button.closest('.ui-element').remove();
            saveButtons();
        }

        function appendToChatLog(message, commandId) {
            const chat = document.getElementById('chat');
            const logEntry = document.createElement('div');
            logEntry.className = 'chat-message';
            logEntry.id = `log-${commandId}`;
            logEntry.innerHTML = `<span class="status-indicator">${getStatusEmoji('queued')}</span><span>${message}</span>`;
            chat.appendChild(logEntry);
            chat.scrollTop = chat.scrollHeight;
            return logEntry;
        }

        function getStatusEmoji(status) {
            return { running: 'ðŸ”„', completed: 'âœ…', failed: 'âŒ', stopped: 'ðŸ›‘' }[status] || 'â“';
        }

        function clearAllInputs() {
            document.getElementById('command-input').value = '';
            document.getElementById('ui-elements').innerHTML = '';
            localStorage.removeItem('customButtons');
        }

        function saveButtons() {
            const buttons = Array.from(document.querySelectorAll('.ui-element')).map(element => {
                const commandButton = element.querySelector('.pure-button-primary');
                return {
                    command: commandButton.textContent,
                    controls: Array.from(element.querySelectorAll('.command-controls input')).map(input => ({
                        type: input.type,
                        id: input.id,
                        value: input.type === 'checkbox' ? input.checked : input.value,
                        min: input.min,
                        max: input.max
                    }))
                };
            });
            localStorage.setItem('customButtons', JSON.stringify(buttons));
        }

        function loadButtons() {
            const buttons = JSON.parse(localStorage.getItem('customButtons')) || [];
            buttons.forEach(buttonData => {
                const element = document.createElement('div');
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'command-controls';
                element.appendChild(controlsDiv);
                const commandFunction = addCommandControls(controlsDiv, buttonData.command);
                element.className = 'ui-element';
                const mainButton = document.createElement('button');
                mainButton.className = 'pure-button pure-button-primary';
                mainButton.textContent = buttonData.command;
                mainButton.onclick = () => sendCommand(commandFunction());
                element.appendChild(mainButton);
                const editButton = document.createElement('button');
                editButton.className = 'pure-button';
                editButton.textContent = 'âœï¸';
                editButton.onclick = () => editElement(editButton);
                element.appendChild(editButton);
                const deleteButton = document.createElement('button');
                deleteButton.className = 'pure-button';
                deleteButton.textContent = 'âŒ';
                deleteButton.onclick = () => deleteElement(deleteButton);
                element.appendChild(deleteButton);
                buttonData.controls.forEach(control => {
                    const input = controlsDiv.querySelector(`#${control.id}`);
                    if (input) {
                        if (control.type === 'checkbox') {
                            input.checked = control.value;
                        } else {
                            input.value = control.value;
                            input.min = control.min;
                            input.max = control.max;
                        }
                    }
                });
                document.getElementById('ui-elements').appendChild(element);
            });
        }

        window.onload = loadButtons;
    </script>
</body>
</html>